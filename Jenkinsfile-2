#!/usr/bin/env groovy

pipeline { // задаем тон groovy, даем понять что здесь у нас шаги пайплайна
    agent any // если у нас есть какие то jenkins агенты специально для Ansible мы можем их указать здесь, у меня только один агент, поэтому я поставлю any
   
    environment {
        ANS_PATH = "/var/lib/jenkins/workspace/jenkinsfile-2/ansible"
        ANS_KEY = credentials("ansible_key")
    }
    stages { // здесь определяем какие шаги в пайплайне
        stage('Deploy') { // наш деплой
            steps { // определяем шаги уже самого стейджа
                sh 'ansible --version' // выводим версию Ansible, команда sh просто выполнит скрипт из консоли
                sh 'ls'
                sh 'pwd' 
                sh 'ls ansible'
                sh 'echo ${ANS_KEY} > ./ansible/ansible_roles.pem'
                sh 'chmod 400 ./ansible/ansible_roles.pem'
                sh 'cd ansible'
                sh 'echo "$USER"'
                sh 'whoami'
                sh 'ls /home/ubuntu/.ssh/'
                sh 'ansible-playbook -i ${ANS_PATH}/hosts ${ANS_PATH}/playbook3.yml'
                // sh ('ansible-playbook -vvvvv -i environments/teal_${ENVIRONMENT} playbooks/yourplaybook.yml -e  --vault-password-file ./.vault_pass.txt')
                }
            }
        }
    }